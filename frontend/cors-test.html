<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Backend CORS Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #responseContainer {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>API Backend CORS Test</h1>
    
    <div class="card">
        <h2>Session Key Test</h2>
        <div>
            <label for="broadcaster">Broadcaster Name:</label>
            <input type="text" id="broadcaster" value="test_broadcaster">
        </div>
        <button id="getSessionKey">Get Session Key</button>
        <div id="sessionKeyResult"></div>
    </div>
    
    <div class="card">
        <h2>Generate Prompt Test</h2>
        <div>
            <label for="sessionKey">Session Key:</label>
            <input type="text" id="sessionKey">
        </div>
        <div>
            <label for="context">Context (JSON):</label>
            <textarea id="context" rows="5">[
  {"type": "chat", "text": "john_doe says hello!", "timestamp": "2023-10-01T12:05:00Z"}
]</textarea>
        </div>
        <button id="generatePrompt">Generate Prompt</button>
        <div id="promptResult"></div>
    </div>
    
    <div id="responseContainer"></div>

    <script>
        document.getElementById('getSessionKey').addEventListener('click', async () => {
            const broadcaster = document.getElementById('broadcaster').value || 'test_broadcaster';
            const resultElement = document.getElementById('sessionKeyResult');
            
            resultElement.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('https://apibackend.adult-webcam-faq.com/api/get-session-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    body: JSON.stringify({
                        username: 'test_user',
                        broadcaster: broadcaster
                    })
                });
                
                const responseText = await response.text();
                
                try {
                    // Try to parse as JSON
                    const data = JSON.parse(responseText);
                    document.getElementById('sessionKey').value = data.sessionKey || '';
                    
                    resultElement.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch (e) {
                    // If not valid JSON, show as text
                    resultElement.innerHTML = `<pre>${responseText}</pre>`;
                }
                
                logResponse('Get Session Key', response, responseText);
                
            } catch (error) {
                resultElement.innerHTML = `<pre>Error: ${error.message}</pre>`;
                logError('Get Session Key', error);
            }
        });
        
        document.getElementById('generatePrompt').addEventListener('click', async () => {
            const sessionKey = document.getElementById('sessionKey').value;
            const broadcaster = document.getElementById('broadcaster').value || 'test_broadcaster';
            const contextText = document.getElementById('context').value;
            const resultElement = document.getElementById('promptResult');
            
            if (!sessionKey) {
                resultElement.innerHTML = '<pre>Error: Session key is required</pre>';
                return;
            }
            
            let context;
            try {
                context = JSON.parse(contextText);
            } catch (e) {
                resultElement.innerHTML = `<pre>Error parsing context JSON: ${e.message}</pre>`;
                return;
            }
            
            resultElement.innerHTML = 'Loading...';
            
            try {
                const response = await fetch('https://apibackend.adult-webcam-faq.com/api/generate-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    body: JSON.stringify({
                        context: context,
                        broadcaster: broadcaster,
                        preferences: '',
                        sessionKey: sessionKey
                    })
                });
                
                const responseText = await response.text();
                
                try {
                    // Try to parse as JSON
                    const data = JSON.parse(responseText);
                    
                    // Update the session key if a new one was provided
                    if (data.sessionKey) {
                        document.getElementById('sessionKey').value = data.sessionKey;
                    }
                    
                    resultElement.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } catch (e) {
                    // If not valid JSON, show as text
                    resultElement.innerHTML = `<pre>${responseText}</pre>`;
                }
                
                logResponse('Generate Prompt', response, responseText);
                
            } catch (error) {
                resultElement.innerHTML = `<pre>Error: ${error.message}</pre>`;
                logError('Generate Prompt', error);
            }
        });
        
        function logResponse(title, response, body) {
            const responseContainer = document.getElementById('responseContainer');
            const card = document.createElement('div');
            card.className = 'card';
            
            let content = `<h3>${title} Response</h3>`;
            content += `<p>Status: ${response.status} ${response.statusText}</p>`;
            
            content += '<h4>Headers:</h4><pre>';
            response.headers.forEach((value, name) => {
                content += `${name}: ${value}\n`;
            });
            content += '</pre>';
            
            content += '<h4>Body:</h4>';
            try {
                const jsonBody = JSON.parse(body);
                content += `<pre>${JSON.stringify(jsonBody, null, 2)}</pre>`;
            } catch (e) {
                content += `<pre>${body}</pre>`;
            }
            
            card.innerHTML = content;
            responseContainer.prepend(card);
        }
        
        function logError(title, error) {
            const responseContainer = document.getElementById('responseContainer');
            const card = document.createElement('div');
            card.className = 'card';
            
            card.innerHTML = `
                <h3>${title} Error</h3>
                <pre>${error.message}</pre>
                <pre>${error.stack}</pre>
            `;
            
            responseContainer.prepend(card);
        }
    </script>
</body>
</html>
